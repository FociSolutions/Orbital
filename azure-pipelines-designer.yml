trigger:
  branches:
    include:
      - "*"
    exclude:
      - master
  paths:
    include:
      - src/orbital-designer/*
      - azure-pipelines-designer.yml

variables:
  buildConfiguration: "Release"

resources:
  containers:
    - container: node
      image: node:14-alpine
      options: --user 0:0

stages:
  - stage: build
    jobs:
      - job: install_and_build
        displayName: install and build
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: Npm@1
            displayName: "npm ci"
            inputs:
              command: ci
              workingDir: "./src/orbital-designer"

          - task: Npm@1
            displayName: "npm run build --prod"
            inputs:
              command: custom
              customCommand: run build -- --prod
              workingDir: "./src/orbital-designer"

          - task: PublishBuildArtifacts@1
            displayName: "Publish angular build artifact orbital-designer"
            inputs:
              PathtoPublish: "./src/orbital-designer/dist"
              ArtifactName: orbital-designer

  - stage: test
    dependsOn: []
    jobs:
      - job: test_and_publish
        displayName: test and publish
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - task: Npm@1
            displayName: "npm ci"
            inputs:
              command: ci
              workingDir: "./src/orbital-designer"

          - task: Npm@1
            displayName: "npm run test:ci"
            inputs:
              command: custom
              customCommand: run test:ci
              workingDir: "./src/orbital-designer"

          - task: PublishCodeCoverageResults@1
            displayName: "Publish angular code coverage results"
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: Cobertura
              summaryFileLocation: "$(System.DefaultWorkingDirectory)/**/cobertura-coverage.xml"
              failIfCoverageEmpty: true

          - task: PublishTestResults@2
            displayName: "Publish angular test results"
            condition: succeededOrFailed()
            inputs:
              searchFolder: $(System.DefaultWorkingDirectory)/src
              testRunTitle: Angular
              testResultsFormat: JUnit
              testResultsFiles: "**/junit.xml"

          - task: Npm@1
            displayName: "npm run lint --format=stylish"
            inputs:
              command: custom
              customCommand: run lint --  --format=stylish
              workingDir: "./src/orbital-designer"
